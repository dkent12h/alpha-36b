/**
 * Alpha 3.6B Strategy Engine (Korean Ver.)
 */

export const getStrategyFeedback = (price, ma20, rsi14, strategyType = 'CORE') => {
    // Convert inputs
    const p = parseFloat(price);
    const m = parseFloat(ma20);
    const r = parseFloat(rsi14);

    if (isNaN(p) || isNaN(m) || isNaN(r)) {
        return {
            action: "ë¡œë”© ì¤‘...",
            reason: "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...",
            color: "text-slate-500",
            type: 'LOADING'
        };
    }

    const disparity = ((p - m) / m) * 100;

    // ---------------------------------------------------------
    // 0. STRONG SELL (ê°•ë ¥ ë§¤ë„) - ì´ˆê³¼ì—´ ìƒíƒœ
    // ---------------------------------------------------------
    if (r >= 75 && disparity >= 10) {
        return {
            action: "ê°•ë ¥ ë§¤ë„ (ì´ˆê³¼ì—´)",
            reason: `RSI ${r.toFixed(1)} ë‹¨ê¸° í­ë“± ë° ì´ê²©ë„ ê³¼ë‹¤(+${disparity.toFixed(1)}%). ì „ëŸ‰ ìµì ˆì„ ê³ ë ¤í•˜ì„¸ìš”.`,
            color: "text-red-500 font-extrabold animate-pulse",
            type: 'SELL'
        };
    }

    // ---------------------------------------------------------
    // 1. SELL (Harvest) - ê³µí†µ ê·œì¹™
    // RSI 70 ì´ìƒì€ ê³¼ì—´ êµ¬ê°„ -> ë§¤ìˆ˜ ê¸ˆì§€ ë° ë¶„í•  ìµì ˆ
    // ---------------------------------------------------------
    if (r >= 70) {
        return {
            action: "ë§¤ë„ (ìµì ˆ)",
            reason: `RSI ${r.toFixed(1)} (ê³¼ì—´). ë¶„í•  ë§¤ë„ë¡œ ìˆ˜ìµì„ ì±™ê¸°ì„¸ìš”.`,
            color: "text-red-500 font-bold",
            type: 'SELL'
        };
    }

    // ---------------------------------------------------------
    // 2. STRONG STOP LOSS (ê°•ë ¥ ì†ì ˆ) - í­ë½ êµ¬ê°„
    // 20ì¼ì„  ëŒ€ë¹„ -10% ì´ìƒ ì´íƒˆ ë˜ëŠ” RSI ê·¹ì €ì¡° í•˜ë½ ì‹œ
    // ---------------------------------------------------------
    if (disparity <= -10.0 && r < 35) {
        return {
            action: "ê°•ë ¥ ì†ì ˆ (í­ë½)",
            reason: `20ì¼ì„  -10% ì´ìƒ í­ë½ ë° RSI ${r.toFixed(1)}. ë°ë“œìº£ ë°”ìš´ìŠ¤ë„ ìœ„í—˜í•œ êµ¬ê°„ì…ë‹ˆë‹¤. ì¦‰ì‹œ ëŒ€í”¼í•˜ì„¸ìš”.`,
            color: "text-red-600 font-extrabold animate-bounce",
            type: 'SELL'
        };
    }

    // ---------------------------------------------------------
    // 2-1. CRITICAL SELL (Stop Loss) - í•˜ë°© ì—´ë¦¼
    // 20ì¼ì„  ëŒ€ë¹„ -5% ì´íƒˆ & RSI 40 ë¯¸ë§Œ ì‹œ ê¸°ê³„ì  ì†ì ˆ
    // ---------------------------------------------------------
    if (disparity <= -5.0 && r < 40) {
        return {
            action: "ì†ì ˆ (í•˜ë°©ì—´ë¦¼)",
            reason: `20ì¼ì„  -5% ì´íƒˆ ë° RSI ${r.toFixed(1)}ğŸ“‰. ì¶”ê°€ ê¸‰ë½ ìœ„í—˜ì´ í½ë‹ˆë‹¤. ë¹„ì¤‘ ì¡°ì ˆì„ ê¶Œì¥í•©ë‹ˆë‹¤.`,
            color: "text-rose-500 font-bold animate-pulse",
            type: 'SELL'
        };
    }

    // ---------------------------------------------------------
    // 3. WAIT (Danger Zone) - ê³µí†µ ê·œì¹™
    // 20ì¼ì„  ì•„ë˜ëŠ” í•˜ë½ ì¶”ì„¸ -> ê´€ë§
    // ---------------------------------------------------------
    if (p < m) {
        return {
            action: "ê´€ë§ (ëŒ€ê¸°)",
            reason: `20ì¼ì„  ì´íƒˆ (ì´ê²©ë„ ${disparity.toFixed(1)}%). í™•ì‹¤í•œ ë°˜ë“± ì „ê¹Œì§€ ë§¤ìˆ˜ ê¸ˆì§€.`,
            color: "text-slate-500",
            type: 'WAIT'
        };
    }

    // ---------------------------------------------------------
    // 3. STRONG BUY (ê°•ë ¥ ë§¤ìˆ˜) - ê³µí†µ ê·œì¹™
    // ---------------------------------------------------------
    // ì¡°ê±´ 1: ê·¹ê³¼ë§¤ë„ (RSI 30 ë¯¸ë§Œ) + ë„ˆë¬´ ê¹Šì§€ ì•Šì€ í•˜ë½ (ì´ê²©ë„ -10% ì´ë‚´)
    // ì¡°ê±´ 2: 20ì¼ì„  ëŒíŒŒ ì´ˆì… (ì´ê²©ë„ 0~1%) + ë°”ë‹¥ íƒˆì¶œ (RSI 40~50 êµ¬ê°„ ìƒìŠ¹)
    if ((r <= 32 && disparity > -10) || (disparity >= 0 && disparity <= 1.0 && r >= 40 && r <= 50)) {
        return {
            action: "ê°•ë ¥ ë§¤ìˆ˜ (ë°”ë‹¥/ëŒíŒŒ)",
            reason: (r <= 32)
                ? `RSI ${r.toFixed(1)} ê·¹ê³¼ë§¤ë„. ë°˜ë“±ì„ ë…¸ë¦¬ëŠ” ì ê·¹ ë§¤ìˆ˜ íƒ€ì ì…ë‹ˆë‹¤.`
                : `20ì¼ì„  ì•ˆì°© í›„ ìƒìŠ¹ ì „í™˜ ì‹œì‘. ê°•ë ¥í•œ ë§¤ìˆ˜ íƒ€ì´ë°ì…ë‹ˆë‹¤.`,
            color: "text-purple-400 font-extrabold animate-pulse",
            type: 'BUY'
        };
    }

    // ---------------------------------------------------------
    // 4. BUY STRATEGIES (Conditional)
    // ---------------------------------------------------------

    // Strategy 2: ëˆŒë¦¼ëª© (CORE, SAFE, INCOME)
    // ì•ˆì •ì  ì¢…ëª©ì€ 20ì¼ì„  ê·¼ì²˜ì—ì„œ ë§¤ìˆ˜
    if (strategyType === 'CORE' || strategyType === 'SAFE' || strategyType === 'INCOME') {
        // ì´ê²©ë„ 0 ~ 3% ì´ë‚´ & RSI 60 ë¯¸ë§Œ (ê³¼ì—´ ì•„ë‹˜)
        if (disparity >= 0 && disparity <= 3.5 && r < 60) {
            return {
                action: "ë§¤ìˆ˜ (ëˆŒë¦¼ëª©)",
                reason: `20ì¼ì„  ì§€ì§€ (ì´ê²© +${disparity.toFixed(1)}%). ë¶„í•  ë§¤ìˆ˜ ì ê¸°ì…ë‹ˆë‹¤.`,
                color: "text-emerald-400 font-bold",
                type: 'BUY'
            };
        }
    }

    // Strategy 1: ëŒíŒŒ (ALPHA)
    // ì„±ì¥ì£¼ëŠ” ì¶”ì„¸ê°€ ê°•í•  ë•Œ ë¶ˆíƒ€ê¸°
    if (strategyType === 'ALPHA') {
        // RSI 60~70 ì‚¬ì´ (ìƒìŠ¹ ëª¨ë©˜í…€ ê°•í•¨)
        if (r >= 60 && r < 70) {
            return {
                action: "ë§¤ìˆ˜ (ëŒíŒŒ)",
                reason: `ê°•í•œ ìƒìŠ¹ ì¶”ì„¸ (RSI ${r.toFixed(1)}). ì „ê³ ì  ëŒíŒŒ ì‹œ ì¶”ê°€ ë§¤ìˆ˜.`,
                color: "text-blue-400 font-bold",
                type: 'BUY'
            };
        }
        // Alpha ì¢…ëª©ì´ë¼ë„ 20ì¼ì„  ê·¼ì²˜ë©´ ë§¤ìˆ˜ ê¸°íšŒ (Top-up)
        if (disparity >= 0 && disparity <= 4.0 && r < 60) {
            return {
                action: "ë§¤ìˆ˜ (ì§€ì§€)",
                reason: `ì¶”ì„¸ì„  ì§€ì§€ í™•ì¸ (ì´ê²© +${disparity.toFixed(1)}%).`,
                color: "text-emerald-400 font-bold",
                type: 'BUY'
            };
        }
    }

    // ---------------------------------------------------------
    // 4. HOLD (ë³´ìœ )
    // ---------------------------------------------------------
    return {
        action: "í™€ë”© (ì§€ì†)",
        reason: "20ì¼ì„  ìœ„ì—ì„œ ì•ˆì •ì ì¸ íë¦„ì„ ìœ ì§€ ì¤‘ì…ë‹ˆë‹¤.",
        color: "text-amber-400",
        type: 'HOLD'
    };
};
